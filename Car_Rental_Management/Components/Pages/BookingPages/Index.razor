@page "/bookings"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using Car_Rental_Management.Domain
@using Car_Rental_Management.Data
@implements IAsyncDisposable
@inject IDbContextFactory<Car_Rental_ManagementContext> DbFactory
@inject AuthenticationStateProvider authenticationStateProvider
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Index</PageTitle>

<h1>Index</h1>

<p>
    <a href="bookings/create">Create New</a>
</p>

@if (!dataLoaded)
{
    <p>Loading...</p>
}
else
{
    <!-- ⭐ Pagination added in QuickGrid -->
    <QuickGrid TGridItem="Booking"
               Items="FilteredBookings.AsQueryable()"
               Pagination="paginationState">

        <PropertyColumn Property="booking => booking.DateOut" Sortable="true" Format="dd/MM/yyyy" />
        <PropertyColumn Property="booking => booking.DateIn" Sortable="true" Format="dd/MM/yyyy" />

        <TemplateColumn Context="booking" Title="Vehicle">
            @GetVehicleString(booking.VehicleId)
        </TemplateColumn>

        <TemplateColumn Context="booking" Title="Customer">
            @GetCustomerString(booking.CustomerId)
        </TemplateColumn>

        <TemplateColumn Context="booking">
            <a href="@($"bookings/edit?id={booking.Id}")">Edit</a> |
            <a href="@($"bookings/details?id={booking.Id}")">Details</a> |
            <AuthorizeView Roles="Administrator">
                | <a href="@($"bookings/delete?id={booking.Id}")">Delete</a>
            </AuthorizeView>
        </TemplateColumn>
    </QuickGrid>

    <!-- ⭐ New paginator (shows page 1 / page 2 etc.) -->
    <Paginator State="paginationState" />
}

@code {
    private Car_Rental_ManagementContext context = default!;
    private string userId = string.Empty;
    private bool isAdmin = false;

    private bool dataLoaded = false;

    // ⭐ Pagination: 1 booking per page (for the lab demo)
    PaginationState paginationState = new PaginationState { ItemsPerPage = 1 };

    // Preloaded lookup data
    private IList<Vehicle> Vehicles = new List<Vehicle>();
    private IList<Customer> Customers = new List<Customer>();
    private Dictionary<int, Make> MakesDict = new();
    private Dictionary<int, Model> ModelsDict = new();
    private Dictionary<int, Colour> ColoursDict = new();

    // Materialized booking list (Fix!)
    private List<Booking> FilteredBookings = new();

    protected override async Task OnInitializedAsync()
    {
        // Authentication
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        userId = user.FindFirst("userId")?.Value ?? string.Empty;
        isAdmin = user.IsInRole("Administrator");

        // DB context
        context = DbFactory.CreateDbContext();

        // Preload lookup tables
        Vehicles = await context.Vehicle.ToListAsync();
        Customers = await context.Customer.ToListAsync();
        MakesDict = await context.Make.ToDictionaryAsync(m => m.Id);
        ModelsDict = await context.Model.ToDictionaryAsync(m => m.Id);
        ColoursDict = await context.Colour.ToDictionaryAsync(c => c.Id);

        // Load bookings into memory FIRST
        var query = isAdmin
            ? context.Booking
            : context.Booking.Where(b => b.CreatedBy == userId);

        FilteredBookings = await query.ToListAsync();

        dataLoaded = true;
    }

    // Vehicle string
    private string GetVehicleString(int vehicleId)
    {
        var vehicle = Vehicles.FirstOrDefault(v => v.Id == vehicleId);
        if (vehicle == null)
            return string.Empty;

        var make = MakesDict.TryGetValue(vehicle.MakeId, out var mk) ? mk.Name : "";
        var model = ModelsDict.TryGetValue(vehicle.ModelId, out var mdl) ? mdl.Name : "";
        var colour = ColoursDict.TryGetValue(vehicle.ColourId, out var clr) ? clr.Name : "";

        return $"{make} {model} {colour}".Trim();
    }

    // Customer string
    private string GetCustomerString(int customerId)
    {
        var customer = Customers.FirstOrDefault(c => c.Id == customerId);

        return customer == null
            ? string.Empty
            : $"{customer.DrivingLicense} - Contact:{customer.ContactNumber}";
    }

    public async ValueTask DisposeAsync() =>
        await context.DisposeAsync();
}
